# 主从复制数据一致性与日志记录格式（binlog）

`binlog` 又分为3种:

- `statement` 格式

把所有数据变化的 `sql` 记录下来，但是如果出现 `now()` , `rand()` , `uuid()` 等函数时，会造成主从不一致的情况；==>基于 `sql` 语句的复制（SBR）

- `row` 格式

不记录每条 `sql` 语句的上下文信息，仅需记录哪条数据被修改了，修改成什么样了。而且不会出现某些特定情况下的存储过程、或 `function` 、或 `trigger` 的调用和触发无法被正确复制的问题。缺点是会产生大量的日志，尤其是 `alter table` 的时候会让日志暴涨。==>基于行的复制（RBR）	

- `mixed` 格式

将 `row` 和 `statement` 结合起来，`DML` 用 `row` ，`DDL` 用 `statement`

	建议使用 `mixed`

## 优缺点对比

### 基于sql语句的复制（SBR）

#### 优点

1. 生成的日志少，节省网络传输io
2. 并不强制要求主从数据库表定义完全一样
3. 相比于基于行的复制方式更为灵活

#### 缺点

1. 对于非确定性事件，无法保证主从复制数据的一致性
2. 对于存储过程，触发器，自定义函数进行的修改也可能造成数据不一致
3. 相比于基于行的复制方式，在从库上执行的时候，要更多的行级锁

### 基于行的复制（RBR）

#### 优点：

1. 可以应用与任何SQL的复制包括非确定函数，存储过程等；
2. 可以减少数据库锁的使用

#### 缺点：

1. 要求主从数据库的表结构必须完全一直，包括列顺序，否则肯会中断复制；
2. 无法在从上单独执行触发器
