## 幂等问题本质

业务层面的幂等问题：业务层面幂等问题本质就是去重逻辑问题

请求层面的幂等问题：一般是重试导致的幂等问题，这类问题本质是分布式事务问题

## 业务层面幂等问题

处理这类问题的核心在于整理出**已知的最细粒度的唯一标识**。我将通过几个例子，分析对应的唯一逻辑。

**案例一：使用手机号注册用户(一个手机号只能注册一个用户)**

```java
这个场景的唯一标识是手机号，对于这类场景，一般的解决方案是：
1）加锁+先查是有已有，没有则创建，已有则返回
2）数据库唯一索引
一般来说，会选择方案一实现，方案二兜底，配合使用
```

**案例二：用户购买商品防重复订单**

```
  这个场景的问题所在是什么呢？用户对于同一个商品依然是可以下多单的。基于这个前提，我们需要理出他的唯一标识是什么？
他的唯一标识在于只能请求只能执行一次（当然案例一也是这个唯一标识，但是他有更细粒度的唯一标识）。
一般的解决方案：
token机制去重:
1.页面层面进页面申请token（一般存redis）,
2.点击提交订单先删除token,
3.然后执行新增订单逻辑，
4.最后返回成功
```

**案例三：用户购买商品防止重复支付**

```
这个场景就是：防止重复支付，唯一标识就是支付的状态，简单的说就是，支付过的就不用支付，待支付的才可以支付；
对于这种情景，由于状态流转负责，就有了网上推荐的 【状态机幂等方案】。
本质上也是先查后操作,当然也可以一个更新的sql解决。这理讨论的是思维思路。
```



**案例四：MVCC 机制**

然后对于更新接口，还有一些资料会提出MVCC机制。MVCC(Multi-Version Concurrency Control) 多版本并发控制。在数据**更新**时需要去比较持有数据的版本号，版本号不一致的操作无法进行更新，更新成功后版本号将会发生变化。思路上，依然是先查后操作。

```java
updateStock(int num, int version) {
    if (version != currentVersion) {
        throw Exception;
    } else {
        stockDao.minStock();
    }
}
```



#### 业务层面幂等问题总结

总结针对业务层面幂等问题，解决问题的思路是：

1）先找出唯一标识、或者是唯一逻辑的点

2）根据唯一标识先查后操作，或者以唯一标识为条件操作

基于这个思路，常见的解决技巧包括：

1）token防重

2）分布式锁、数据库层面悲观锁、乐观锁、唯一索引

3）状态机幂等

4）select+insert/select+update

5）MVCC

## 请求层面幂等

请求层面幂等更多体现在分布式事务。因为请求层面的重复一般是因为rpc重试,网关重发,Nginx重发等等异常情况。这种问题最简单的思路就是解决方案就是不重试。

如果要重试，那么如果能保证分布式事务。那么在基于业务层面幂等的情况下，请求重试时，依然可以保证幂等。