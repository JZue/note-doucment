https://www.cnblogs.com/Dhouse/p/8295995.html

https://blog.csdn.net/sunhuiliang85/article/details/75092403



#### Redis 为什么要给客户端分配输入缓冲区

​	对于Redis服务器的输出（也就是命令的返回值）来说，其大小通常是不可控制的。有可能一个简单的命令，能够产生体积庞大的返回数据。另外也有可能因为执行了太多命令，导致产生返回数据的速率超过了往客户端发送的速率，这是也会导致服务器堆积大量消息，从而导致输出缓冲区越来越大，占用过多内存，甚至导致系统崩溃。

​	Redis为每个客户端分配了输入缓冲区，它的作用是将客户端发送的命令临时保存，同时Redis会到输入缓冲区拉取命令并执行，输入缓冲区为客户端发送命令道Redis执行命令提供了缓冲功能。qbuf代表了输入缓冲区的大小，qbuf-free代表输入缓冲区的剩余容量。输入缓冲区会根据输入内容的大小动态调整，每个客户端的输入缓冲区大小不能超过1G。超过后客户端将被关闭。

#### 缓冲区过大的危害

（1）      一旦客户端的输入缓冲区超过1G，客户端将会被关闭

（2）      输入缓冲区不受maxmemory的控制，假设一个Redis设置了maxmemory为4G，已经存储了2G数据，但是如果此时输入缓冲区使用了3GB，已经超过了maxmemeory限制，可能会产生数据丢失，键值淘汰，OOM等情况。

#### 引起输入缓冲区过大的原因

1）      redis的处理速度跟不是输入缓冲区的输入速度，并且每次进入输入缓冲区的命令包含大量的bigkey，从而造成了输入缓冲区过大的情况。

（2）      redis发生了阻塞，短期内不能处理命令。造成客户端命令积压在输入缓冲区，导致输入缓冲区过大。

#### 避免机制

所幸，Redis设置了一些保护机制来避免这种情况的出现，不同类型的客户端有不同的限制参数。限制方式有如下两种：

（1）、大小限制，当某一个客户端的缓冲区超过某一个大小值时，直接关闭这个客户端的连接；

（2）、持续性限制，当某一个客户端的缓冲区持续一段时间占用过大空间时，会直接关闭客户端连接。



